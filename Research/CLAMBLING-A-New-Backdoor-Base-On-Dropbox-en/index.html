
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="&lt;Theo/&gt;">
    <title>CLAMBLING - A New Backdoor Base On Dropbox (EN) - &lt;Theo/&gt;</title>
    <meta name="author" content="Theo Chen">
    
        <meta name="keywords" content="CLAMLING,DRBControl,APT,Dropbox,DLL Side-Loading">
    
    
        <link rel="icon" href="https://blog.theo.com.tw/assets/images/favicon.ico">
    
    
        
            <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss2.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Theo Chen","sameAs":["https://github.com/TheoKlein","https://twitter.com/The0_Klein","https://www.linkedin.com/in/theo-chen/","mailto:theokleintw@gmail.com"],"image":"https://www.gravatar.com/avatar/9b495e199d8dad2130ecb4407dca4176"},"articleBody":"In July 2019, one of our customer’s company suffering the APT attack and we start the investigation immediately. During the investigation we found a brand new backdoor sample, which implements lots of features by using Dropbox API, using Dropbox like a C&amp;C server. After the reverse engineering, we extract the Dropbox token used by the sample, dig into Dropbox folder, and reveal the whole functional structure.\n\nThis article is published on Talent-Jump Technologies, Inc. simultaneously.\n\n\nThe report is co-authored with Trend Micro.\nKenney Lu, Daniel Lunghi, Cedric Pernet, and Jamz Yaneza. (17 February 2020). Trend Micro. “Operation DRBControl - Uncovering A Cyberespionage Campaign Targeting Gambling Companies In Southeast Asia”\n\n中文版本\n\n\nFirst Stage InfectionThe threat actor uses Windows Defender Core Process MsMpEng.exe which has a legal digital signature to load the malicious DLL file. Load the shellcode from the payload file then release the final malicious executable to complete the first stage infection.\nDuring the investigation, we found a total of 8 different loader’s filenames [Appendix 1] renamed from MsMpEng.exe and placed at C:\\ProgramData\\Microsoft in its separated folder. The loader is just called the function ServiceCrtMain imported from mpsvc.dll.\nThe malicious DLL file mpsvc.dll has two types [Appendix 2]. The older type will try to read shellcode from payload file English.rtf, decode and decompress the content using RtlDecompressBuffer to release the final executable (Figure 1).\nFigure 1. Older type of mpsvc.dll\n\nThe newer one has a different way to start the infection. There is a piece of shellcode hard-coded in the mpsvc.dll, after decoding the shellcode from mpsvc.dll, it will inject and execute to load the shellcode from mpsvc.mui (Figure 2), which will release the final executable and inject into the process.\nFigure 2. Newer type of mpsvc.dll\n\nBoth of these two types of mpsvc.dll will release a full functional backdoor, which can connect to the C&amp;C server. But the final executable released by a newer type of mpsvc.dll has some upgrade, including the function to interact with Dropbox API. The following article will focus on the malicious executable released by the newer type of mpsvc.dll.\nThe hardcoded shellcode in a newer type of mpsvc.dll will first allocate 0x80000 bytes of memory space. Getting the current module’s full path and replace the extension dll to mui and read the shellcode in this mui file, then jump to the base address of mui file plus its first byte. (Figure 3)\nFigure 3. Decoded shellcode in mpsvc.dll\n\nIn the end, the shellcode in mpsvc.mui has another different piece of hard-coded bytes, which will decompress by RtlDecompressBuffer to the final malicious executable (Figure 4).\nFigure 4. The final malicious executable in buffer.\n\nSample AnalysisThe final malicious executable sample we extracted has numerous features. Here is the analysis of some major functions.\nBypass UACThis sample can bypass UAC via .NET. It is not a new technique which was disclosed in 2017 [1], the threat actor only changes the GUID to 9BA94120-7E02-46ee-ADC6-10640B04F93B (Figure 5) and specify the location of DLL file which will load by the .NET application in the elevated process.\nFigure 5. Code snippet of bypass UAC.\n\nPersistenceThere are two ways to persist. Register as a startup program in HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run if it has no privileged (Figure 6). Otherwise, it will register itself as a system service (Figure 7).\nFigure 6. Register as a start program.\nFigure 7. Register as  a system service.\n\nInformation GatheringIt will collect some basic information like IP address, hostname, username, OS version and so on. Also, it will search the registry key’s value HKEY_CURRENT_USER\\\\Software\\\\Bitcoin\\\\Bitcoin-Qt and try to look for the wallet address if exist (Figure 8). All of this information will upload to Dropbox as %Y-%m-%d %H-%M-%S.log, below is a file sample:\n1234567Lan IP: x.x.x.xComputer: WIN-XXXXXXUserName: AdministratorOS: Win10(X64)Version: 8.0Bit: Not Found !!!Exist: NO\n\nFigure 8. Code snippet of information gathering.\n\nRecording FeaturesThis sample acquired three types of recording features, including key-log, clipboard log, and screen recording. The screen recording file naming format is [%y-%m-%d] %H-%M-%S.avi. The key-log and clipboard log will encode by different key and salt, then save as &lt;hash&gt;.pas for key-log and &lt;hash&gt;.log for clipboard log (Figure 9).\nFigure 9. Code snippet of key log encoding.\n\nConnect to C&amp;C ServerThis sample can also connect to a specific C&amp;C server and send back data by using a fake HTTP POST request (Figure 10).\nFigure 10. Code snippet of preparing for fake POST request.\n\nRTTI InformationThe RTTI information remaining, here is the full class name list we got:\n\nCHPAvi\nCHPCmd\nCHPExplorer\nCHPHttp\nCHPKeyLog\nCHPNet\nCHPPipe\nCHPPlugin\nCHPProcess\nCHPProxy\nCHPRegedit\nCHPScreen\nCHPService\nCHPTcp\nCHPTelnet\nCHPUdp\n\nInteract With DropboxDuring reverse engineering, we found that the Dropbox API token with 64 characters is hardcoded in stack string (Figure 11).\nFigure 11. Code snippet for the first 24 characters of Dropbox API token.\n\nBesides connecting to the C&amp;C server, this sample can also upload &amp; download with Dropbox API. Especially when the log file is uploaded, it will try to download bin.asc and check the file has fake GIF file header or not. If everything is correct, it will continue to the custom decoding phase, which will calculate with an array of bytes hard-coded in the sample, to release the inject payload (Figure 12).\nFigure 12. Code snippet of interaction with Dropbox API.\n\nInside of Dropbox FolderAfter we got the Dropbox token, we can now dig into Dropbox by using official API, for example, list the account information which creates this token, list the full file and folder information.\nIn the Dropbox, the folder structure like this:\n123456/&lt;unique_hash&gt;/%Y-%m-%d\\ %H:%M:%S.log/&lt;unique_hash&gt;/bin.asc/codex64bin.asc/codex86bin.asc/x64bin.asc/x86bin.asc\n\nEach infected victim has its folder named by unique hash /[0-9A-z]/, this hash is generated by machine key and some other information. %Y-%m-%d\\ %H:%M:%S.log is the log file upload by the victim. *.asc is the file upload by the threat actor. For example, bin.asc is the payload download by the victim when the log file is upload succeeds.\nSort out the log file on Dropbox, we can get the full list of infected computers (Figure 13).\nFigure 13. The list of infected computers.\n\nSecond Stage InfectionAfter the first infection stage completed, it will persistent itself as a system service or autorun program. Collecting information and establish a connection to the C&amp;C server. The most interesting part is each time when the log file is upload succeeds, it will try to download bin.asc from each computer’s unique folder. Most of bin.asc we captured is requesting the victim to download x64bin.asc file from Dropbox.\nFurther analysis of x64bin.asc, we found the second Dropbox API token, its purpose is different from the first one. Now the threat actor is ready to use Dropbox as another C&amp;C server with the full backdoor feature.\nThe second infection stage’s sample has some bonus features including the ability to interact with Dropbox, the command code mapping show as below:\n|Command Code|Action||:—:|:—\t||2\t|ListDrives\t||3\t|ListFiles\t||4\t|ExecuteFile\t||5\t|ManageFile\t||6\t|UploadFile\t||7\t|DownloadFile\t||8\t|OpenTerminal\t|\nIn these commands, there are three different files, each of these file has specific filename and purpose:\n\neLHgZNBH: The status file, upload to Dropbox at regular intervals.\nyasHPHFJ: The command file, containing command and arguments.\ncsaujdnc: The execution result of the command.\n\nThe status file eLHgZNBH contain the basic information about victim and timestamp, upload to Dropbox at regular intervals. Whenever status file upload succeeds, it will try to download the command file yasHPHFJ if it existed. Extract the command  code and arguments from yasHPHFJ then execute the command and upload the execution result to Dropbox as csaujdnc (Figure 14).\nFigure 14. Flow of three files interact with Dropbox\n\nBy using this control flow, the threat actor can use Dropbox as a C&amp;C server to control the victim’s computer even the fixed connection between the specific C&amp;C server’s IP address has been found and blocked. Unless we block content.dropboxapi.com and api.dropboxapi.com, otherwise we can not isolate the infected computer.\nThe Dropbox API remain the detail of each file and folder, for example this is a file information return by Dropbox API:\n12345678910111213&#123;    &#x27;.tag&#x27;: &#x27;file&#x27;,    &#x27;name&#x27;: &#x27;Secret_File.txt&#x27;,    &#x27;path_lower&#x27;: &#x27;/secret_file.txt&#x27;,    &#x27;path_display&#x27;: &#x27;/Secret_File.txt&#x27;,    &#x27;id&#x27;: &#x27;id:&lt;UNIQUE_FILE_ID&gt;&#x27;,    &#x27;client_modified&#x27;: &#x27;2019-07-21T02:45:42Z&#x27;,    &#x27;server_modified&#x27;: &#x27;2019-07-21T02:53:04Z&#x27;,    &#x27;rev&#x27;: &#x27;[0-9a-f]&#123;6,&#125;&#x27;,    &#x27;size&#x27;: 125,    &#x27;is_downloadable&#x27;: True,    &#x27;content_hash&#x27;: &#x27;&lt;SHA256_HASH&gt;&#x27;&#125;\n\nIt contains the server_modified timestamp even with history revision file id, we can use rev to list the full history of this file and download it. Sort out this information and the command code mapping, we can now list the full command executed on each computer and its arguments. Here is two computers’ execution list (Figure 15 &amp; 16).\nFigure 15. Real command execution list from one victim.\nFigure 16. Another real command execution list.\n\nAccording to these record, the threat actor follows almost the same action on every infected computer. First, download additional attack programs from Dropbox, like mimikatz or other UAC bypass tools. Second, search the high-value file including private source code, config file, database, and the key-log &#x2F; clipboard log. Upload all of these files to Dropbox for further searching. Last but not least, infiltrate the company intranet or even the cloud service.\nCombining all decoded yasHPHFJ files, we can show the threat actor’s approximate working hours (Figure 17).\nFigure 17. The threat actor’s approximate working hours.\n\nConclusionWe start to monitor the Dropbox for each token and parse the infected computer’s list, here we can see the infected computer’s number from July 2019 to September 2019 this two month (Figure 18 &amp; 19).\nFigure 18. Dropbox A (first token): infected computer’s number.\nFigure 19. Dropbox B (second token): infected computer’s number.\n\nWe got nearly 200 infected computers at the highest peak from Dropbox A, alone with nearly 80 computers from Dropbox B. Both of these static has a drop at August 21, 2019, the threat actor clear the Dropbox folder for some reason. Monitoring ends on September 20, 2019, all tokens we got are revoked by the threat actor.\nDuring these two months, we got five different Dropbox token. Each of these tokens has its purpose. The first two tokens are the major one we discuss in this article, others are more like for testing.\nFrom the first infection stage, established the connection between the C&amp;C server and Dropbox at the same time. If the IP address of the C&amp;C server been blocked, it can still have limited control from Dropbox. Once it completed the second infection stage, Dropbox is turning into a second channel C&amp;C server which has full remote control features (Figure 20). Steal the data and infiltrate the whole company. This method is not complex but very useful.\nFigure 20. The whole interaction flow from infection to interact with Dropbox.\n\nAppendix\nLoader\n\n33bc14d231a4afaa18f06513766d5f69d8b88f1e697cd127d24fb4b72ad44c7a\nmsmpeng.exe (PE32)\n\n\n99042e895b6c2ea80f3ba65563a12c8eba882e3ad6a21dd8e799b0112c75ddd2\nrsoplicy.exe (PE32+)\nDRM.exe (PE32+)\nFirewall.exe (PE32+)\nKaspe.exe (PE32+)\nRSoPProv.exe (PE32+)\nVideo.exe (PE32+)\nWinDRM.exe (PE32+)\n\n\n\n\nDLL &amp; Payload File\n\nmpsvc.dll\na58946c10c8325040634f7cd04429b9f1e3715767d0c8aec46b7cba8975e6a69\ne18af309ecc3bc93351b9fa13a451e8b55b71d9edcc4232bc53eb1092bdfa859\n\n\nEnglish.rtf\n52c147c8eadb58d3580b39c023ce4a90dacce76ee5c30c56c56ea39939a56b52\nb5546d4931a0316abd4018c982558ed808b4d0a60233ac18bee601fa09d95ee6\ndd0399970d2dbb5ab8b5869e2fafb83194c992f27bbb244adce35e2fe6ef0d28\n\n\nmpsvc.mui\n0693713f995285e8bd99ebfca2c4f0f1a8e824dafb5a99693442a9256df06e02\n24ebd398be23135a2d8aa7000c2b6a534448b87aa5708b8546089630a8035f7e\n56758c25e3b00957c6f7f76fcea5d0598eff7eda98c63f50b51d1c28f267ac8f\n96282a625a31b6bf646c6e01ad20de96fd63c345881a9c91190940121580059d\n99663b9ba27a36ff9fc64b72213e933067ee0cde38b39d20ae4326a37185811d\n9dd1d21e9431cfe25709a8f26ec0f605ed19cf64ca1922e97fad7b7f2d2e82ea\nb226c8e85a7b1a6d4d29d42fc84bc7f3a32335fc7ba44b455a7716d706660873\ne716506cf54f48d77382d8955512184b45dd7d0b58c22e32424c56d38db24360\n\n\n\n\n\n\nOther IoCs\nDrop Files\n\n37286285cb0f8305bd23a693b2e7ace71538e4c0b9f13ee6ca4e9e9419657813\nb3581e8611f5838fc205f66bc5ca5edddb0fd895e97ebf8f0c7220cb102ae14b\n79928578cdd646a9724bc6851a1ee77820c81a3100788d62885f9d92b6814085\n7602e2932a10f3750a5d6236f6c1662047d4475c6e1fe6c57118c6620a083cb3\n5b5aff8869ba7f1d3f6ad7711e801b031aedeff287a0dcb8f8ae6d6e4eb468af\n412260ab5d9b2b2aa4471b953fb67ddc1a0fe90c353e391819ca7ac1c6d3146f\nc6064fb44733b5660557e223598d0e4d5c4448ad20b29e41bef469cb5df77da0\n4c08bc1a2f5384c5306edc6f23e4249526517eb21a88763c8180a582438dfa31\na58f2fea8c74c1d25090014c7366db224102daa6c798fcdfb7168b569b7d5ca2\nd201e726fd2a2f4b55ea5ca95f0429d74e2efb918c7c136d55ef392ceac854d6\n5713907c01db40cf54155db19c0c44c046b2c676a492d5ba13d39118c95139bf\nd72c3f5f2f291f7092afd5a0fcaceaf2eaae44d057c9b3b27dd53f2048ed6175\nd62ddac7c4aa152cf6f988db6c7bd0c9dcffa2e890d354b7e9db7f3b843fd270\n28d2637139231c78a6493cd91e8f0d10891cfeb6c5e758540515faa29f54b6b2\n39e69ab52f073f966945fdab214f63368f71175a7ccbea199fae32d51fa6a4e7\n260b64e287d13d04f1f38d956c10d9fdd3cfbff6ba0040a52223fa41605bb975\nc425b73be7394032aa8e756259ebf3662c000afaa286c3d7d957891026f3cbb4\n28d19a23d167db3e1282f1c6039bcda6556798be054994a55e60116827dd0bf1\nc3c1fc6aabbb49d0ee281ba4fc1529d2b9832a67b18e08ce14dbf0e361e5bd85\nfc865a720cb808354923092bac04ab6a75e20ea92db5a343af07365c0cd2b72a\n24f501141af5bf059509145e165302dd7087b1d1c2136bc5e4403f01435f250e\nee5f7e6ad4a344f40b9babada1654ea22333bb5150cfd26bfc239ead28b6528c\nca26a34153972cc73c63d3a9aadd3b12ba35ecdc6e39025b75be56b00c20e0ae\n1951c79f280692a43b7c7cafd45c3f5d7f4f841ae104a6cad814fab4641c79f2\nd5129308ee83a852e6a320ca68c8e66ed6d1eb4ec584dd0c8b5f313a56c49a15\n\n\nIP\n\n103.230.15.130\n104.168.196.80\n104.168.196.85\n104.168.196.88\n139.180.194.173\n167.179.115.228\n207.148.73.58\n43.228.126.172\n43.228.126.56\n45.32.101.238\n45.32.111.228\n45.77.41.49\n47.75.248.237\n66.42.60.107\n\n\nDomains\n\nfn.shopingchina.net\noffice.support.googldevice.com\nsafe.mircosofdevice.com\nserver.correomasivochile.com\nsrv2.mkt-app.com\nstore.microsoftbetastore.com\nupdate.mircosotfdefender.com\n\n\n\n\n\nReferences\nUAC bypass via elevated .NET applications\nDropbox for HTTP Developers\nKenney Lu, Daniel Lunghi, Cedric Pernet, and Jamz Yaneza. (17 February 2020). Trend Micro. “Operation DRBControl - Uncovering A Cyberespionage Campaign Targeting Gambling Companies In Southeast Asia”\n\n\nPhoto by Fotis Fotopoulos on Unsplash\n\n","dateCreated":"2020-02-17T14:11:13+00:00","dateModified":"2025-01-17T13:11:16+00:00","datePublished":"2020-02-17T14:11:13+00:00","description":"In July 2019, one of our customer’s company suffering the APT attack and we start the investigation immediately. During the investigation we found a brand new backdoor sample, which implements lots of features by using Dropbox API, using Dropbox like a C&amp;C server. After the reverse engineering, we extract the Dropbox token used by the sample, dig into Dropbox folder, and reveal the whole functional structure.","headline":"CLAMBLING - A New Backdoor Base On Dropbox (EN)","image":["thumb.jpg","cover.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"},"publisher":{"@type":"Organization","name":"Theo Chen","sameAs":["https://github.com/TheoKlein","https://twitter.com/The0_Klein","https://www.linkedin.com/in/theo-chen/","mailto:theokleintw@gmail.com"],"image":"https://www.gravatar.com/avatar/9b495e199d8dad2130ecb4407dca4176","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/9b495e199d8dad2130ecb4407dca4176"}},"url":"https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/","keywords":"Malware, APT, IncidentResponse","thumbnailUrl":"thumb.jpg"}</script>
    
    <meta name="description" content="In July 2019, one of our customer’s company suffering the APT attack and we start the investigation immediately. During the investigation we found a brand new backdoor sample, which implements lots of">
<meta property="og:type" content="blog">
<meta property="og:title" content="CLAMBLING - A New Backdoor Base On Dropbox (EN)">
<meta property="og:url" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/index.html">
<meta property="og:site_name" content="&lt;Theo&#x2F;&gt;">
<meta property="og:description" content="In July 2019, one of our customer’s company suffering the APT attack and we start the investigation immediately. During the investigation we found a brand new backdoor sample, which implements lots of">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/cover.jpg">
<meta property="article:published_time" content="2020-02-17T14:11:13.000Z">
<meta property="article:modified_time" content="2025-01-17T13:11:16.668Z">
<meta property="article:author" content="Theo Chen">
<meta property="article:tag" content="Malware">
<meta property="article:tag" content="APT">
<meta property="article:tag" content="IncidentResponse">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/cover.jpg">
<meta name="twitter:creator" content="@The0_Klein">
    
    
        
    
    
    
        <meta property="og:image" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/thumb.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/thumb.jpg"/>
    
    
        <meta property="og:image" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/cover.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/cover.jpg"/>
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-gdcyhoyuzwa8smbm8vz2yfxz7vo2renh92pv061urgkby5doa9lemz924ywr.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-106120242-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-106120242-2');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            &lt;Theo/&gt;
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/9b495e199d8dad2130ecb4407dca4176?s=90" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/9b495e199d8dad2130ecb4407dca4176?s=110" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Theo Chen</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Penetration Testing &#x2F; Malware Analysis &#x2F; Threat Hunting &#x2F; APT Research<br /><br />Ingress Enlightened Agent</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/TheoKlein"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/The0_Klein"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/theo-chen/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:theokleintw@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/rss2.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    "
             style="background-image:url('/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/cover.jpg');"
             data-behavior="2">
            
        </div>

            <div id="main" data-behavior="2"
                 class="hasCover
                        hasCoverMetaOut
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            CLAMBLING - A New Backdoor Base On Dropbox (EN)
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-02-17T14:11:13+00:00">
	
		    Feb 17, 2020
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Research/">Research</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>In July 2019, one of our customer’s company suffering the APT attack and we start the investigation immediately. During the investigation we found a brand new backdoor sample, which implements lots of features by using Dropbox API, using Dropbox like a C&amp;C server. After the reverse engineering, we extract the Dropbox token used by the sample, dig into Dropbox folder, and reveal the whole functional structure.<span id="more"></span></p>
<blockquote>
<p>This article is published on <a target="_blank" rel="noopener" href="http://www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/">Talent-Jump Technologies, Inc.</a> simultaneously.</p>
</blockquote>
<blockquote>
<p>The report is co-authored with <a target="_blank" rel="noopener" href="https://www.trendmicro.com/">Trend Micro</a>.</p>
<p>Kenney Lu, Daniel Lunghi, Cedric Pernet, and Jamz Yaneza. (17 February 2020). Trend Micro. <a target="_blank" rel="noopener" href="https://www.trendmicro.com/vinfo/us/security/news/cyber-attacks/operation-drbcontrol-uncovering-a-cyberespionage-campaign-targeting-gambling-companies-in-southeast-asia">“Operation DRBControl - Uncovering A Cyberespionage Campaign Targeting Gambling Companies In Southeast Asia”</a></p>
</blockquote>
<p><a href="/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox">中文版本</a></p>
<h1 id="table-of-contents">Table of Contents</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#First-Stage-Infection"><span class="toc-text">First Stage Infection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sample-Analysis"><span class="toc-text">Sample Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-UAC"><span class="toc-text">Bypass UAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Persistence"><span class="toc-text">Persistence</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Information-Gathering"><span class="toc-text">Information Gathering</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recording-Features"><span class="toc-text">Recording Features</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connect-to-C-C-Server"><span class="toc-text">Connect to C&amp;C Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RTTI-Information"><span class="toc-text">RTTI Information</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interact-With-Dropbox"><span class="toc-text">Interact With Dropbox</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Inside-of-Dropbox-Folder"><span class="toc-text">Inside of Dropbox Folder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Second-Stage-Infection"><span class="toc-text">Second Stage Infection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix"><span class="toc-text">Appendix</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol>

<h2 id="First-Stage-Infection"><a href="#First-Stage-Infection" class="headerlink" title="First Stage Infection"></a>First Stage Infection</h2><p>The threat actor uses Windows Defender Core Process <code>MsMpEng.exe</code> which has a legal digital signature to load the malicious DLL file. Load the shellcode from the payload file then release the final malicious executable to complete the first stage infection.</p>
<p>During the investigation, we found a total of 8 different loader’s filenames <sub><a href="#Appendix">[Appendix 1]</a></sub> renamed from <code>MsMpEng.exe</code> and placed at <code>C:\ProgramData\Microsoft</code> in its separated folder. The loader is just called the function <code>ServiceCrtMain</code> imported from <code>mpsvc.dll</code>.</p>
<p>The malicious DLL file <code>mpsvc.dll</code> has two types <sub><a href="#Appendix">[Appendix 2]</a></sub>. The older type will try to read shellcode from payload file <code>English.rtf</code>, decode and decompress the content using <code>RtlDecompressBuffer</code> to release the final executable (Figure 1).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-01.png" title="Figure 1. Older type of mpsvc.dll" data-caption="Figure 1. Older type of mpsvc.dll" data-fancybox="default"><img class="fig-img" src="clambling-01.png" alt="Figure 1. Older type of mpsvc.dll"></a><span class="caption">Figure 1. Older type of mpsvc.dll</span></div>

<p>The newer one has a different way to start the infection. There is a piece of shellcode hard-coded in the <code>mpsvc.dll</code>, after decoding the shellcode from <code>mpsvc.dll</code>, it will inject and execute to load the shellcode from <code>mpsvc.mui</code> (Figure 2), which will release the final executable and inject into the process.</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-02.png" title="Figure 2. Newer type of mpsvc.dll" data-caption="Figure 2. Newer type of mpsvc.dll" data-fancybox="default"><img class="fig-img" src="clambling-02.png" alt="Figure 2. Newer type of mpsvc.dll"></a><span class="caption">Figure 2. Newer type of mpsvc.dll</span></div>

<p>Both of these two types of <code>mpsvc.dll</code> will release a full functional backdoor, which can connect to the C&amp;C server. But the final executable released by a newer type of <code>mpsvc.dll</code> has some upgrade, including the function to interact with Dropbox API. The following article will focus on the malicious executable released by the newer type of <code>mpsvc.dll</code>.</p>
<p>The hardcoded shellcode in a newer type of <code>mpsvc.dll</code> will first allocate 0x80000 bytes of memory space. Getting the current module’s full path and replace the extension <code>dll</code> to <code>mui</code> and read the shellcode in this <code>mui</code> file, then jump to the base address of <code>mui</code> file plus its first byte. (Figure 3)</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-03.png" title="Figure 3. Decoded shellcode in mpsvc.dll" data-caption="Figure 3. Decoded shellcode in mpsvc.dll" data-fancybox="default"><img class="fig-img" src="clambling-03.png" alt="Figure 3. Decoded shellcode in mpsvc.dll"></a><span class="caption">Figure 3. Decoded shellcode in mpsvc.dll</span></div>

<p>In the end, the shellcode in <code>mpsvc.mui</code> has another different piece of hard-coded bytes, which will decompress by <code>RtlDecompressBuffer</code> to the final malicious executable (Figure 4).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-04.png" title="Figure 4. The final malicious executable in buffer." data-caption="Figure 4. The final malicious executable in buffer." data-fancybox="default"><img class="fig-img" src="clambling-04.png" alt="Figure 4. The final malicious executable in buffer."></a><span class="caption">Figure 4. The final malicious executable in buffer.</span></div>

<h2 id="Sample-Analysis"><a href="#Sample-Analysis" class="headerlink" title="Sample Analysis"></a>Sample Analysis</h2><p>The final malicious executable sample we extracted has numerous features. Here is the analysis of some major functions.</p>
<h3 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h3><p>This sample can bypass UAC via .NET. It is not a new technique which was disclosed in 2017 <sub><a href="#References">[1]</a></sub>, the threat actor only changes the GUID to <code>9BA94120-7E02-46ee-ADC6-10640B04F93B</code> (Figure 5) and specify the location of DLL file which will load by the .NET application in the elevated process.</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-05.png" title="Figure 5. Code snippet of bypass UAC." data-caption="Figure 5. Code snippet of bypass UAC." data-fancybox="default"><img class="fig-img" src="clambling-05.png" alt="Figure 5. Code snippet of bypass UAC."></a><span class="caption">Figure 5. Code snippet of bypass UAC.</span></div>

<h3 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h3><p>There are two ways to persist. Register as a startup program in <code>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</code> if it has no privileged (Figure 6). Otherwise, it will register itself as a system service (Figure 7).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-06.png" title="Figure 6. Register as a start program." data-caption="Figure 6. Register as a start program." data-fancybox="default"><img class="fig-img" src="clambling-06.png" alt="Figure 6. Register as a start program."></a><span class="caption">Figure 6. Register as a start program.</span></div>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-07.png" title="Figure 7. Register as  a system service." data-caption="Figure 7. Register as  a system service." data-fancybox="default"><img class="fig-img" src="clambling-07.png" alt="Figure 7. Register as  a system service."></a><span class="caption">Figure 7. Register as  a system service.</span></div>

<h3 id="Information-Gathering"><a href="#Information-Gathering" class="headerlink" title="Information Gathering"></a>Information Gathering</h3><p>It will collect some basic information like IP address, hostname, username, OS version and so on. Also, it will search the registry key’s value <code>HKEY_CURRENT_USER\\Software\\Bitcoin\\Bitcoin-Qt</code> and try to look for the wallet address if exist (Figure 8). All of this information will upload to Dropbox as <code>%Y-%m-%d %H-%M-%S.log</code>, below is a file sample:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Lan IP: x.x.x.x</span><br><span class="line">Computer: WIN-XXXXXX</span><br><span class="line">UserName: Administrator</span><br><span class="line">OS: Win10(X64)</span><br><span class="line">Version: 8.0</span><br><span class="line">Bit: Not Found !!!</span><br><span class="line">Exist: NO</span><br></pre></td></tr></table></figure>

<div class="figure center" style="width:;"><a class="fancybox" href="clambling-08.png" title="Figure 8. Code snippet of information gathering." data-caption="Figure 8. Code snippet of information gathering." data-fancybox="default"><img class="fig-img" src="clambling-08.png" alt="Figure 8. Code snippet of information gathering."></a><span class="caption">Figure 8. Code snippet of information gathering.</span></div>

<h3 id="Recording-Features"><a href="#Recording-Features" class="headerlink" title="Recording Features"></a>Recording Features</h3><p>This sample acquired three types of recording features, including key-log, clipboard log, and screen recording. The screen recording file naming format is <code>[%y-%m-%d] %H-%M-%S.avi</code>. The key-log and clipboard log will encode by different key and salt, then save as <code>&lt;hash&gt;.pas</code> for key-log and <code>&lt;hash&gt;.log</code> for clipboard log (Figure 9).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-09.png" title="Figure 9. Code snippet of key log encoding." data-caption="Figure 9. Code snippet of key log encoding." data-fancybox="default"><img class="fig-img" src="clambling-09.png" alt="Figure 9. Code snippet of key log encoding."></a><span class="caption">Figure 9. Code snippet of key log encoding.</span></div>

<h3 id="Connect-to-C-C-Server"><a href="#Connect-to-C-C-Server" class="headerlink" title="Connect to C&amp;C Server"></a>Connect to C&amp;C Server</h3><p>This sample can also connect to a specific C&amp;C server and send back data by using a fake HTTP POST request (Figure 10).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-10.png" title="Figure 10. Code snippet of preparing for fake POST request." data-caption="Figure 10. Code snippet of preparing for fake POST request." data-fancybox="default"><img class="fig-img" src="clambling-10.png" alt="Figure 10. Code snippet of preparing for fake POST request."></a><span class="caption">Figure 10. Code snippet of preparing for fake POST request.</span></div>

<h3 id="RTTI-Information"><a href="#RTTI-Information" class="headerlink" title="RTTI Information"></a>RTTI Information</h3><p>The RTTI information remaining, here is the full class name list we got:</p>
<ul>
<li>CHPAvi</li>
<li>CHPCmd</li>
<li>CHPExplorer</li>
<li>CHPHttp</li>
<li>CHPKeyLog</li>
<li>CHPNet</li>
<li>CHPPipe</li>
<li>CHPPlugin</li>
<li>CHPProcess</li>
<li>CHPProxy</li>
<li>CHPRegedit</li>
<li>CHPScreen</li>
<li>CHPService</li>
<li>CHPTcp</li>
<li>CHPTelnet</li>
<li>CHPUdp</li>
</ul>
<h3 id="Interact-With-Dropbox"><a href="#Interact-With-Dropbox" class="headerlink" title="Interact With Dropbox"></a>Interact With Dropbox</h3><p>During reverse engineering, we found that the Dropbox API token with 64 characters is hardcoded in stack string (Figure 11).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-11.png" title="Figure 11. Code snippet for the first 24 characters of Dropbox API token." data-caption="Figure 11. Code snippet for the first 24 characters of Dropbox API token." data-fancybox="default"><img class="fig-img" src="clambling-11.png" alt="Figure 11. Code snippet for the first 24 characters of Dropbox API token."></a><span class="caption">Figure 11. Code snippet for the first 24 characters of Dropbox API token.</span></div>

<p>Besides connecting to the C&amp;C server, this sample can also upload &amp; download with Dropbox API. Especially when the log file is uploaded, it will try to download <code>bin.asc</code> and check the file has fake <code>GIF</code> file header or not. If everything is correct, it will continue to the custom decoding phase, which will calculate with an array of bytes hard-coded in the sample, to release the inject payload (Figure 12).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-12.png" title="Figure 12. Code snippet of interaction with Dropbox API." data-caption="Figure 12. Code snippet of interaction with Dropbox API." data-fancybox="default"><img class="fig-img" src="clambling-12.png" alt="Figure 12. Code snippet of interaction with Dropbox API."></a><span class="caption">Figure 12. Code snippet of interaction with Dropbox API.</span></div>

<h2 id="Inside-of-Dropbox-Folder"><a href="#Inside-of-Dropbox-Folder" class="headerlink" title="Inside of Dropbox Folder"></a>Inside of Dropbox Folder</h2><p>After we got the Dropbox token, we can now dig into Dropbox by using official API, for example, list the account information which creates this token, list the full file and folder information.</p>
<p>In the Dropbox, the folder structure like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/&lt;unique_hash&gt;/%Y-%m-%d\ %H:%M:%S.log</span><br><span class="line">/&lt;unique_hash&gt;/bin.asc</span><br><span class="line">/codex64bin.asc</span><br><span class="line">/codex86bin.asc</span><br><span class="line">/x64bin.asc</span><br><span class="line">/x86bin.asc</span><br></pre></td></tr></table></figure>

<p>Each infected victim has its folder named by unique hash <code>/[0-9A-z]/</code>, this hash is generated by machine key and some other information. <code>%Y-%m-%d\ %H:%M:%S.log</code> is the log file upload by the victim. <code>*.asc</code> is the file upload by the threat actor. For example, <code>bin.asc</code> is the payload download by the victim when the log file is upload succeeds.</p>
<p>Sort out the log file on Dropbox, we can get the full list of infected computers (Figure 13).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-13.png" title="Figure 13. The list of infected computers." data-caption="Figure 13. The list of infected computers." data-fancybox="default"><img class="fig-img" src="clambling-13.png" alt="Figure 13. The list of infected computers."></a><span class="caption">Figure 13. The list of infected computers.</span></div>

<h2 id="Second-Stage-Infection"><a href="#Second-Stage-Infection" class="headerlink" title="Second Stage Infection"></a>Second Stage Infection</h2><p>After the first infection stage completed, it will persistent itself as a system service or autorun program. Collecting information and establish a connection to the C&amp;C server. The most interesting part is each time when the log file is upload succeeds, it will try to download <code>bin.asc</code> from each computer’s unique folder. Most of <code>bin.asc</code> we captured is requesting the victim to download <code>x64bin.asc</code> file from Dropbox.</p>
<p>Further analysis of <code>x64bin.asc</code>, we found the second Dropbox API token, its purpose is different from the first one. Now the threat actor is ready to use Dropbox as another C&amp;C server with the full backdoor feature.</p>
<p>The second infection stage’s sample has some bonus features including the ability to interact with Dropbox, the command code mapping show as below:</p>
<p>|Command Code|Action|<br>|:—:|:—	|<br>|2	|ListDrives	|<br>|3	|ListFiles	|<br>|4	|ExecuteFile	|<br>|5	|ManageFile	|<br>|6	|UploadFile	|<br>|7	|DownloadFile	|<br>|8	|OpenTerminal	|</p>
<p>In these commands, there are three different files, each of these file has specific filename and purpose:</p>
<ul>
<li><code>eLHgZNBH</code>: The status file, upload to Dropbox at regular intervals.</li>
<li><code>yasHPHFJ</code>: The command file, containing command and arguments.</li>
<li><code>csaujdnc</code>: The execution result of the command.</li>
</ul>
<p>The status file <code>eLHgZNBH</code> contain the basic information about victim and timestamp, upload to Dropbox at regular intervals. Whenever status file upload succeeds, it will try to download the command file <code>yasHPHFJ</code> if it existed. Extract the command  code and arguments from <code>yasHPHFJ</code> then execute the command and upload the execution result to Dropbox as <code>csaujdnc</code> (Figure 14).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-14.png" title="Figure 14. Flow of three files interact with Dropbox" data-caption="Figure 14. Flow of three files interact with Dropbox" data-fancybox="default"><img class="fig-img" src="clambling-14.png" alt="Figure 14. Flow of three files interact with Dropbox"></a><span class="caption">Figure 14. Flow of three files interact with Dropbox</span></div>

<p>By using this control flow, the threat actor can use Dropbox as a C&amp;C server to control the victim’s computer even the fixed connection between the specific C&amp;C server’s IP address has been found and blocked. Unless we block <code>content.dropboxapi.com</code> and <code>api.dropboxapi.com</code>, otherwise we can not isolate the infected computer.</p>
<p>The Dropbox API remain the detail of each file and folder, for example this is a file information return by Dropbox API:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;.tag&#x27;: &#x27;file&#x27;,</span><br><span class="line">    &#x27;name&#x27;: &#x27;Secret_File.txt&#x27;,</span><br><span class="line">    &#x27;path_lower&#x27;: &#x27;/secret_file.txt&#x27;,</span><br><span class="line">    &#x27;path_display&#x27;: &#x27;/Secret_File.txt&#x27;,</span><br><span class="line">    &#x27;id&#x27;: &#x27;id:&lt;UNIQUE_FILE_ID&gt;&#x27;,</span><br><span class="line">    &#x27;client_modified&#x27;: &#x27;2019-07-21T02:45:42Z&#x27;,</span><br><span class="line">    &#x27;server_modified&#x27;: &#x27;2019-07-21T02:53:04Z&#x27;,</span><br><span class="line">    &#x27;rev&#x27;: &#x27;[0-9a-f]&#123;6,&#125;&#x27;,</span><br><span class="line">    &#x27;size&#x27;: 125,</span><br><span class="line">    &#x27;is_downloadable&#x27;: True,</span><br><span class="line">    &#x27;content_hash&#x27;: &#x27;&lt;SHA256_HASH&gt;&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It contains the server_modified timestamp even with history revision file id, we can use <code>rev</code> to list the full history of this file and download it. Sort out this information and the command code mapping, we can now list the full command executed on each computer and its arguments. Here is two computers’ execution list (Figure 15 &amp; 16).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-15.png" title="Figure 15. Real command execution list from one victim." data-caption="Figure 15. Real command execution list from one victim." data-fancybox="default"><img class="fig-img" src="clambling-15.png" alt="Figure 15. Real command execution list from one victim."></a><span class="caption">Figure 15. Real command execution list from one victim.</span></div>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-16.png" title="Figure 16. Another real command execution list." data-caption="Figure 16. Another real command execution list." data-fancybox="default"><img class="fig-img" src="clambling-16.png" alt="Figure 16. Another real command execution list."></a><span class="caption">Figure 16. Another real command execution list.</span></div>

<p>According to these record, the threat actor follows almost the same action on every infected computer. First, download additional attack programs from Dropbox, like <code>mimikatz</code> or other UAC bypass tools. Second, search the high-value file including private source code, config file, database, and the key-log &#x2F; clipboard log. Upload all of these files to Dropbox for further searching. Last but not least, infiltrate the company intranet or even the cloud service.</p>
<p>Combining all decoded <code>yasHPHFJ</code> files, we can show the threat actor’s approximate working hours (Figure 17).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-17.png" title="Figure 17. The threat actor’s approximate working hours." data-caption="Figure 17. The threat actor’s approximate working hours." data-fancybox="default"><img class="fig-img" src="clambling-17.png" alt="Figure 17. The threat actor’s approximate working hours."></a><span class="caption">Figure 17. The threat actor’s approximate working hours.</span></div>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We start to monitor the Dropbox for each token and parse the infected computer’s list, here we can see the infected computer’s number from July 2019 to September 2019 this two month (Figure 18 &amp; 19).</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-18.png" title="Figure 18. Dropbox A (first token): infected computer’s number." data-caption="Figure 18. Dropbox A (first token): infected computer’s number." data-fancybox="default"><img class="fig-img" src="clambling-18.png" alt="Figure 18. Dropbox A (first token): infected computer’s number."></a><span class="caption">Figure 18. Dropbox A (first token): infected computer’s number.</span></div>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-19.png" title="Figure 19. Dropbox B (second token): infected computer’s number." data-caption="Figure 19. Dropbox B (second token): infected computer’s number." data-fancybox="default"><img class="fig-img" src="clambling-19.png" alt="Figure 19. Dropbox B (second token): infected computer’s number."></a><span class="caption">Figure 19. Dropbox B (second token): infected computer’s number.</span></div>

<p>We got nearly 200 infected computers at the highest peak from Dropbox A, alone with nearly 80 computers from Dropbox B. Both of these static has a drop at August 21, 2019, the threat actor clear the Dropbox folder for some reason. Monitoring ends on September 20, 2019, all tokens we got are revoked by the threat actor.</p>
<p>During these two months, we got five different Dropbox token. Each of these tokens has its purpose. The first two tokens are the major one we discuss in this article, others are more like for testing.</p>
<p>From the first infection stage, established the connection between the C&amp;C server and Dropbox at the same time. If the IP address of the C&amp;C server been blocked, it can still have limited control from Dropbox. Once it completed the second infection stage, Dropbox is turning into a second channel C&amp;C server which has full remote control features (Figure 20). Steal the data and infiltrate the whole company. This method is not complex but very useful.</p>
<div class="figure center" style="width:;"><a class="fancybox" href="clambling-20.png" title="Figure 20. The whole interaction flow from infection to interact with Dropbox." data-caption="Figure 20. The whole interaction flow from infection to interact with Dropbox." data-fancybox="default"><img class="fig-img" src="clambling-20.png" alt="Figure 20. The whole interaction flow from infection to interact with Dropbox."></a><span class="caption">Figure 20. The whole interaction flow from infection to interact with Dropbox.</span></div>

<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><ol>
<li><p>Loader</p>
<ul>
<li><code>33bc14d231a4afaa18f06513766d5f69d8b88f1e697cd127d24fb4b72ad44c7a</code><ul>
<li><code>msmpeng.exe</code> (PE32)</li>
</ul>
</li>
<li><code>99042e895b6c2ea80f3ba65563a12c8eba882e3ad6a21dd8e799b0112c75ddd2</code><ul>
<li><code>rsoplicy.exe</code> (PE32+)</li>
<li><code>DRM.exe</code> (PE32+)</li>
<li><code>Firewall.exe</code> (PE32+)</li>
<li><code>Kaspe.exe</code> (PE32+)</li>
<li><code>RSoPProv.exe</code> (PE32+)</li>
<li><code>Video.exe</code> (PE32+)</li>
<li><code>WinDRM.exe</code> (PE32+)</li>
</ul>
</li>
</ul>
</li>
<li><p>DLL &amp; Payload File</p>
<ul>
<li><code>mpsvc.dll</code><ul>
<li><code>a58946c10c8325040634f7cd04429b9f1e3715767d0c8aec46b7cba8975e6a69</code></li>
<li><code>e18af309ecc3bc93351b9fa13a451e8b55b71d9edcc4232bc53eb1092bdfa859</code></li>
</ul>
</li>
<li><code>English.rtf</code><ul>
<li><code>52c147c8eadb58d3580b39c023ce4a90dacce76ee5c30c56c56ea39939a56b52</code></li>
<li><code>b5546d4931a0316abd4018c982558ed808b4d0a60233ac18bee601fa09d95ee6</code></li>
<li><code>dd0399970d2dbb5ab8b5869e2fafb83194c992f27bbb244adce35e2fe6ef0d28</code></li>
</ul>
</li>
<li><code>mpsvc.mui</code><ul>
<li><code>0693713f995285e8bd99ebfca2c4f0f1a8e824dafb5a99693442a9256df06e02</code></li>
<li><code>24ebd398be23135a2d8aa7000c2b6a534448b87aa5708b8546089630a8035f7e</code></li>
<li><code>56758c25e3b00957c6f7f76fcea5d0598eff7eda98c63f50b51d1c28f267ac8f</code></li>
<li><code>96282a625a31b6bf646c6e01ad20de96fd63c345881a9c91190940121580059d</code></li>
<li><code>99663b9ba27a36ff9fc64b72213e933067ee0cde38b39d20ae4326a37185811d</code></li>
<li><code>9dd1d21e9431cfe25709a8f26ec0f605ed19cf64ca1922e97fad7b7f2d2e82ea</code></li>
<li><code>b226c8e85a7b1a6d4d29d42fc84bc7f3a32335fc7ba44b455a7716d706660873</code></li>
<li><code>e716506cf54f48d77382d8955512184b45dd7d0b58c22e32424c56d38db24360</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<ul>
<li>Other IoCs<ul>
<li><p>Drop Files</p>
<ul>
<li><code>37286285cb0f8305bd23a693b2e7ace71538e4c0b9f13ee6ca4e9e9419657813</code></li>
<li><code>b3581e8611f5838fc205f66bc5ca5edddb0fd895e97ebf8f0c7220cb102ae14b</code></li>
<li><code>79928578cdd646a9724bc6851a1ee77820c81a3100788d62885f9d92b6814085</code></li>
<li><code>7602e2932a10f3750a5d6236f6c1662047d4475c6e1fe6c57118c6620a083cb3</code></li>
<li><code>5b5aff8869ba7f1d3f6ad7711e801b031aedeff287a0dcb8f8ae6d6e4eb468af</code></li>
<li><code>412260ab5d9b2b2aa4471b953fb67ddc1a0fe90c353e391819ca7ac1c6d3146f</code></li>
<li><code>c6064fb44733b5660557e223598d0e4d5c4448ad20b29e41bef469cb5df77da0</code></li>
<li><code>4c08bc1a2f5384c5306edc6f23e4249526517eb21a88763c8180a582438dfa31</code></li>
<li><code>a58f2fea8c74c1d25090014c7366db224102daa6c798fcdfb7168b569b7d5ca2</code></li>
<li><code>d201e726fd2a2f4b55ea5ca95f0429d74e2efb918c7c136d55ef392ceac854d6</code></li>
<li><code>5713907c01db40cf54155db19c0c44c046b2c676a492d5ba13d39118c95139bf</code></li>
<li><code>d72c3f5f2f291f7092afd5a0fcaceaf2eaae44d057c9b3b27dd53f2048ed6175</code></li>
<li><code>d62ddac7c4aa152cf6f988db6c7bd0c9dcffa2e890d354b7e9db7f3b843fd270</code></li>
<li><code>28d2637139231c78a6493cd91e8f0d10891cfeb6c5e758540515faa29f54b6b2</code></li>
<li><code>39e69ab52f073f966945fdab214f63368f71175a7ccbea199fae32d51fa6a4e7</code></li>
<li><code>260b64e287d13d04f1f38d956c10d9fdd3cfbff6ba0040a52223fa41605bb975</code></li>
<li><code>c425b73be7394032aa8e756259ebf3662c000afaa286c3d7d957891026f3cbb4</code></li>
<li><code>28d19a23d167db3e1282f1c6039bcda6556798be054994a55e60116827dd0bf1</code></li>
<li><code>c3c1fc6aabbb49d0ee281ba4fc1529d2b9832a67b18e08ce14dbf0e361e5bd85</code></li>
<li><code>fc865a720cb808354923092bac04ab6a75e20ea92db5a343af07365c0cd2b72a</code></li>
<li><code>24f501141af5bf059509145e165302dd7087b1d1c2136bc5e4403f01435f250e</code></li>
<li><code>ee5f7e6ad4a344f40b9babada1654ea22333bb5150cfd26bfc239ead28b6528c</code></li>
<li><code>ca26a34153972cc73c63d3a9aadd3b12ba35ecdc6e39025b75be56b00c20e0ae</code></li>
<li><code>1951c79f280692a43b7c7cafd45c3f5d7f4f841ae104a6cad814fab4641c79f2</code></li>
<li><code>d5129308ee83a852e6a320ca68c8e66ed6d1eb4ec584dd0c8b5f313a56c49a15</code></li>
</ul>
</li>
<li><p>IP</p>
<ul>
<li><code>103.230.15.130</code></li>
<li><code>104.168.196.80</code></li>
<li><code>104.168.196.85</code></li>
<li><code>104.168.196.88</code></li>
<li><code>139.180.194.173</code></li>
<li><code>167.179.115.228</code></li>
<li><code>207.148.73.58</code></li>
<li><code>43.228.126.172</code></li>
<li><code>43.228.126.56</code></li>
<li><code>45.32.101.238</code></li>
<li><code>45.32.111.228</code></li>
<li><code>45.77.41.49</code></li>
<li><code>47.75.248.237</code></li>
<li><code>66.42.60.107</code></li>
</ul>
</li>
<li><p>Domains</p>
<ul>
<li><code>fn.shopingchina.net</code></li>
<li><code>office.support.googldevice.com</code></li>
<li><code>safe.mircosofdevice.com</code></li>
<li><code>server.correomasivochile.com</code></li>
<li><code>srv2.mkt-app.com</code></li>
<li><code>store.microsoftbetastore.com</code></li>
<li><code>update.mircosotfdefender.com</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://offsec.provadys.com/UAC-bypass-dotnet.html">UAC bypass via elevated .NET applications</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dropbox.com/developers/documentation/http/overview">Dropbox for HTTP Developers</a></li>
<li><a target="_blank" rel="noopener" href="https://www.trendmicro.com/vinfo/us/security/news/cyber-attacks/operation-drbcontrol-uncovering-a-cyberespionage-campaign-targeting-gambling-companies-in-southeast-asia">Kenney Lu, Daniel Lunghi, Cedric Pernet, and Jamz Yaneza. (17 February 2020). <em>Trend Micro</em>. “Operation DRBControl - Uncovering A Cyberespionage Campaign Targeting Gambling Companies In Southeast Asia”</a></li>
</ol>
<blockquote>
<p>Photo by <a target="_blank" rel="noopener" href="https://unsplash.com/@ffstop">Fotis Fotopoulos</a> on <a target="_blank" rel="noopener" href="https://unsplash.com/">Unsplash</a></p>
</blockquote>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/APT/" rel="tag">APT</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/IncidentResponse/" rel="tag">IncidentResponse</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/Malware/" rel="tag">Malware</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/Research/%E6%96%B0-XLoader-%E8%AE%8A%E7%A8%AE%E7%9E%84%E6%BA%96%E6%97%A5%E6%9C%AC%E9%9B%BB%E4%BF%A1%E5%95%86%E5%8F%8A%E9%8A%80%E8%A1%8C%E9%80%B2%E8%A1%8C%E7%B6%B2%E8%B7%AF%E9%87%A3%E9%AD%9A/"
                    data-tooltip="新 XLoader 變種瞄準日本電信商及銀行進行網路釣魚"
                    aria-label="PREVIOUS: 新 XLoader 變種瞄準日本電信商及銀行進行網路釣魚"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox/"
                    data-tooltip="CLAMBLING - A New Backdoor Base On Dropbox"
                    aria-label="NEXT: CLAMBLING - A New Backdoor Base On Dropbox"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="Table of Contents">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Theo Chen. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/Research/%E6%96%B0-XLoader-%E8%AE%8A%E7%A8%AE%E7%9E%84%E6%BA%96%E6%97%A5%E6%9C%AC%E9%9B%BB%E4%BF%A1%E5%95%86%E5%8F%8A%E9%8A%80%E8%A1%8C%E9%80%B2%E8%A1%8C%E7%B6%B2%E8%B7%AF%E9%87%A3%E9%AD%9A/"
                    data-tooltip="新 XLoader 變種瞄準日本電信商及銀行進行網路釣魚"
                    aria-label="PREVIOUS: 新 XLoader 變種瞄準日本電信商及銀行進行網路釣魚"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox/"
                    data-tooltip="CLAMBLING - A New Backdoor Base On Dropbox"
                    aria-label="NEXT: CLAMBLING - A New Backdoor Base On Dropbox"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="Table of Contents">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="2">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/9b495e199d8dad2130ecb4407dca4176?s=110" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Theo Chen</h4>
        
            <div id="about-card-bio"><p>Penetration Testing &#x2F; Malware Analysis &#x2F; Threat Hunting &#x2F; APT Research<br /><br />Ingress Enlightened Agent</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Threat Researcher</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Taipei, Taiwan
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-ntjm1xxqdwr7uhkrlwal4hkgsjrprt8jr4d5cauo3fpjpjoa3nude4bnfikw.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://blog.theo.com.tw/Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/';
              
            this.page.identifier = 'Research/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'theo-5';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
